<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Professional Valuation Engine ‚Äì Real-Time DCF</title>
<style>
    * { box-sizing: border-box; }
    body {
        margin: 0;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        background: linear-gradient(135deg, #0b0f19 0%, #111827 100%);
        color: #e5e7eb;
        min-height: 100vh;
        padding: 24px;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    h1 { margin: 0 0 8px; font-size: 2.4rem; font-weight: 800; background: linear-gradient(90deg, #4cc9f0, #4361ee); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .subtitle { color:#9ca3af; margin-bottom: 16px; font-size: 0.95rem; }
    .pill { display:inline-block; padding:4px 10px; border-radius:999px; background:#19233a; color:#8be9ff; font-size:13px; margin-bottom:10px; }
    .input-group { display:flex; gap:12px; flex-wrap:wrap; margin-bottom:16px; }
    input { flex:1; min-width:200px; padding:14px 16px; border-radius:12px; border:2px solid #23304a; background:#101526; color:white; font-size:15px; }
    input::placeholder { color:#6b7280; }
    input:focus { outline:none; border-color:#4cc9f0; box-shadow:0 0 0 3px rgba(76,201,240,0.2); }
    button { padding:14px 18px; background: linear-gradient(135deg, #4cc9f0 0%, #4361ee 100%); border:none; color:#0b0f19; font-weight:700; border-radius:12px; cursor:pointer; min-width:120px; }
    button:hover { transform: translateY(-1px); box-shadow:0 4px 16px rgba(76,201,240,0.35); }
    button:active { transform: translateY(0); }
    button:disabled { opacity:0.5; cursor:not-allowed; transform:none; }
    .progress { margin: 16px 0; }
    .progress-bar { width: 100%; height: 8px; background: #1f2940; border-radius: 4px; overflow: hidden; }
    .progress-fill { height: 100%; background: linear-gradient(90deg, #4cc9f0, #4361ee); transition: width 0.3s; }
    #status { min-height:18px; color:#4cc9f0; font-size:14px; margin-bottom:10px; }
    .results-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap:14px; margin-bottom:16px; }
    .card { background: linear-gradient(135deg, #0e1320 0%, #1a1f35 100%); padding:18px; border-radius:16px; border:1px solid #1f2940; box-shadow:0 4px 12px rgba(0,0,0,0.3); }
    .card h3 { margin:0 0 6px; font-size:0.85rem; text-transform:uppercase; letter-spacing:0.5px; color:#9ca3af; }
    .card .value { font-size:1.7rem; font-weight:700; margin:0 0 4px; }
    .card .subvalue { font-size:0.9rem; color:#9ca3af; }
    .positive { color:#4ade80; }
    .negative { color:#f87171; }
    .neutral { color:#fbbf24; }
    .detail-section { background: linear-gradient(135deg, #0e1320 0%, #1a1f35 100%); padding:20px; border-radius:16px; margin-top:14px; border:1px solid #1f2940; box-shadow:0 4px 12px rgba(0,0,0,0.3); }
    .detail-section h2 { margin:0 0 12px; color:#4cc9f0; font-size:1.1rem; }
    .valuation-methods { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); gap:10px; }
    .method-card { background:#0b0f19; padding:14px; border-radius:12px; border:1px solid #23304a; }
    .method-name { font-size:0.8rem; color:#9ca3af; margin-bottom:6px; text-transform:uppercase; letter-spacing:0.5px; }
    .method-value { font-size:1.2rem; font-weight:700; }
    .scenario-tabs { display: flex; gap: 8px; margin-bottom: 16px; }
    .scenario-tab { padding: 8px 16px; background: #0b0f19; border: 1px solid #23304a; border-radius: 8px; cursor: pointer; font-size: 0.9rem; }
    .scenario-tab.active { background: #4cc9f0; color: #0b0f19; border-color: #4cc9f0; }
    .metric-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #23304a; }
    .metric-label { color: #9ca3af; }
    .metric-value { font-weight: 600; }
    .muted { color:#9ca3af; font-size:0.9rem; }
    .disclaimer { margin-top:16px; padding:14px; background: rgba(251,191,36,0.1); border-left:4px solid #fbbf24; border-radius:10px; color:#fbbf24; font-size:0.9rem; }
    pre { background:#0e1320; color:#e5e7eb; padding:12px; border-radius:12px; overflow:auto; font-size: 0.85rem; }
    .data-quality { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; margin-left: 8px; }
    .quality-high { background: rgba(74, 222, 128, 0.2); color: #4ade80; }
    .quality-medium { background: rgba(251, 191, 36, 0.2); color: #fbbf24; }
    .quality-low { background: rgba(248, 113, 113, 0.2); color: #f87171; }
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(11, 15, 25, 0.9); }
    .modal-content { background: linear-gradient(135deg, #0e1320 0%, #1a1f35 100%); margin: 5% auto; padding: 30px; border: 1px solid #1f2940; border-radius: 16px; max-width: 700px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .modal-header h2 { margin: 0; color: #4cc9f0; font-size: 1.5rem; }
    .close { color: #9ca3af; font-size: 32px; font-weight: bold; cursor: pointer; line-height: 1; }
    .close:hover { color: #4cc9f0; }
    .help-section { margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #23304a; }
    .help-section:last-child { border-bottom: none; }
    .help-section h3 { color: #4cc9f0; font-size: 1.1rem; margin-bottom: 10px; }
    .help-section ul { margin: 10px 0; padding-left: 20px; }
    .help-section li { margin-bottom: 8px; color: #9ca3af; }
    .sample-tickers { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px; }
    .sample-ticker { padding: 6px 12px; background: #19233a; color: #8be9ff; border-radius: 6px; font-size: 0.9rem; cursor: pointer; }
    .sample-ticker:hover { background: #4cc9f0; color: #0b0f19; }
    .skeleton { animation: pulse 1.5s ease-in-out infinite; background: linear-gradient(90deg, #1f2940 0%, #23304a 50%, #1f2940 100%); background-size: 200% 100%; border-radius: 8px; }
    @keyframes pulse { 0%, 100% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } }
    @media (max-width: 768px) { button { width:100%; } .input-group { flex-direction:column; } h1 { font-size:2rem; } .modal-content { margin: 10% 5%; padding: 20px; } }
</style>
</head>
<body>
<div class="container">
  <div class="pill">Real-Time Professional Valuation ‚Ä¢ Finnhub API</div>
  <h1>Professional Valuation Engine</h1>
  <div class="subtitle">Full implementation of "◊î◊û◊ì◊®◊ô◊ö ◊ú◊î◊¢◊®◊õ◊™ ◊©◊ï◊ï◊ô ◊ó◊ë◊®◊ï◊™": 10-step DCF + Market Approach + Asset-Based + Adjustments with real-time data</div>

  <div class="input-group">
    <input id="ticker" placeholder="Enter ticker symbol (AAPL, MSFT, GOOGL, TSLA, etc.)" type="text" value="AAPL">
    <button id="valueBtn" onclick="showAdvancedSettings()">Full DCF Analysis</button>
    <button onclick="testAPI()" style="background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);">Test API</button>
    <button onclick="showHelp()" style="background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);">Help</button>
  </div>

  <div style="display:flex; gap:8px; margin-bottom:16px; flex-wrap:wrap;" id="exportButtons"></div>

  <div class="progress" id="progressContainer" style="display:none;">
    <div class="progress-bar">
      <div class="progress-fill" id="progressFill" style="width:0%"></div>
    </div>
  </div>

  <div id="status"></div>

  <div id="results" style="display:none;">
    <div class="scenario-tabs">
      <div class="scenario-tab active" onclick="switchScenario('base')">Base Case</div>
      <div class="scenario-tab" onclick="switchScenario('bull')">Bull Case</div>
      <div class="scenario-tab" onclick="switchScenario('bear')">Bear Case</div>
    </div>

    <div class="results-grid">
      <div class="card">
        <h3>Current Price <span class="data-quality" id="dataQuality">‚Äî</span></h3>
        <div class="value" id="currentPrice">‚Äî</div>
        <div class="subvalue" id="marketCap">‚Äî</div>
      </div>
      <div class="card">
        <h3>Fair Value (Weighted)</h3>
        <div class="value" id="fairValue">‚Äî</div>
        <div class="subvalue" id="fairValueRange">‚Äî</div>
      </div>
      <div class="card">
        <h3>Upside/Downside</h3>
        <div class="value" id="upside">‚Äî</div>
        <div class="subvalue" id="recommendation">‚Äî</div>
      </div>
      <div class="card">
        <h3>WACC</h3>
        <div class="value" id="waccValue">‚Äî</div>
        <div class="subvalue" id="waccBreakdown">‚Äî</div>
      </div>
    </div>

    <div class="detail-section">
      <h2>Valuation Synthesis (Book Methodology)</h2>
      <div class="valuation-methods" id="valuationMethods"></div>
    </div>

    <div class="detail-section">
      <h2>DCF Model (5-Year Projection)</h2>
      <div id="dcfProjection"></div>
    </div>

    <div class="detail-section">
      <h2>Market Approach - Comparable Analysis</h2>
      <div id="marketApproach"></div>
    </div>

    <div class="detail-section">
      <h2>Asset-Based Valuation</h2>
      <div id="assetBased"></div>
    </div>

    <div class="detail-section">
      <h2>Adjustments & Premiums</h2>
      <div id="adjustments"></div>
    </div>

    <div class="detail-section">
      <h2>Financial Metrics & Normalized Data</h2>
      <div id="financialMetrics"></div>
    </div>

    <div class="detail-section">
      <h2>Risk Analysis & Assumptions</h2>
      <div id="assumptions"></div>
      <pre id="bookSummary"></pre>
    </div>

    <div class="disclaimer">
      ‚ö†Ô∏è Professional Valuation Tool: Uses real-time data from Finnhub. This is for educational purposes only and not investment advice. Always conduct independent research and consult qualified professionals before making investment decisions.
    </div>
  </div>
</div>

<!-- Help Modal -->
<div id="helpModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>How to Use the Valuation Engine</h2>
      <span class="close" onclick="closeHelp()">&times;</span>
    </div>

    <div class="help-section">
      <h3>Quick Start</h3>
      <ol style="color: #9ca3af; padding-left: 20px;">
        <li>Enter a US stock ticker symbol (e.g., AAPL, MSFT, GOOGL)</li>
        <li>Click "Full DCF Analysis" to run the complete valuation</li>
        <li>Wait for the 10-step analysis to complete (~10-15 seconds)</li>
        <li>Review results and switch between Base/Bull/Bear scenarios</li>
      </ol>
      <div class="sample-tickers">
        <div class="sample-ticker" onclick="tryTicker('AAPL')">AAPL</div>
        <div class="sample-ticker" onclick="tryTicker('MSFT')">MSFT</div>
        <div class="sample-ticker" onclick="tryTicker('GOOGL')">GOOGL</div>
        <div class="sample-ticker" onclick="tryTicker('TSLA')">TSLA</div>
        <div class="sample-ticker" onclick="tryTicker('NVDA')">NVDA</div>
        <div class="sample-ticker" onclick="tryTicker('META')">META</div>
      </div>
    </div>

    <div class="help-section">
      <h3>Understanding the Results</h3>
      <ul>
        <li><strong>Fair Value:</strong> Weighted average of DCF (55%), Market (30%), and Asset (15%) approaches</li>
        <li><strong>Upside/Downside:</strong> Percentage difference between fair value and current market price</li>
        <li><strong>WACC:</strong> Weighted Average Cost of Capital - the discount rate used for DCF</li>
        <li><strong>Data Quality:</strong> HIGH (real data), MEDIUM (mixed), LOW (mostly estimates)</li>
      </ul>
    </div>

    <div class="help-section">
      <h3>Three Scenarios Explained</h3>
      <ul>
        <li><strong>Base Case:</strong> Most likely scenario with moderate assumptions</li>
        <li><strong>Bull Case:</strong> Optimistic scenario with higher growth rates</li>
        <li><strong>Bear Case:</strong> Conservative scenario with lower growth rates</li>
      </ul>
    </div>

    <div class="help-section">
      <h3>Export Options</h3>
      <ul>
        <li><strong>PDF:</strong> Complete valuation report with all sections</li>
        <li><strong>Excel:</strong> Financial data and projections in spreadsheet format</li>
        <li><strong>JSON:</strong> Raw data for further analysis</li>
      </ul>
    </div>

    <div class="help-section">
      <h3>Tips for Best Results</h3>
      <ul>
        <li>Use well-established companies with good data coverage</li>
        <li>Large-cap stocks (>$10B market cap) have more complete data</li>
        <li>Results are cached for 5 minutes to improve performance</li>
        <li>Compare multiple scenarios to understand valuation range</li>
      </ul>
    </div>
  </div>
</div>

<!-- Advanced Settings Modal -->
<div id="advancedModal" class="modal">
  <div class="modal-content" style="max-width: 900px;">
    <div class="modal-header">
      <h2>‚öôÔ∏è Advanced Valuation Settings</h2>
      <span class="close" onclick="closeAdvancedSettings()">&times;</span>
    </div>

    <!-- Phase 1: Normalization Adjustments -->
    <div class="help-section">
      <h3>üìä Phase 1: Normalization Adjustments</h3>
      <p style="color: #9ca3af; margin-bottom: 12px;">Adjust financials for non-market rates and non-recurring items</p>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
        <div>
          <label style="color: #9ca3af; font-size: 0.9rem;">Owner Salary Adjustment ($)</label>
          <input type="number" id="ownerSalaryAdj" placeholder="e.g., 100000" style="width: 100%; margin-top: 4px;" value="0">
          <div style="font-size: 0.8rem; color: #6b7280; margin-top: 2px;">Excess/deficit vs market rate</div>
        </div>

        <div>
          <label style="color: #9ca3af; font-size: 0.9rem;">Related-Party Rent Adjustment ($)</label>
          <input type="number" id="rentAdj" placeholder="e.g., 50000" style="width: 100%; margin-top: 4px;" value="0">
          <div style="font-size: 0.8rem; color: #6b7280; margin-top: 2px;">Above/below market rent</div>
        </div>

        <div>
          <label style="color: #9ca3af; font-size: 0.9rem;">Non-Recurring Revenue ($)</label>
          <input type="number" id="nonRecurringRev" placeholder="e.g., 500000" style="width: 100%; margin-top: 4px;" value="0">
          <div style="font-size: 0.8rem; color: #6b7280; margin-top: 2px;">One-time revenue to remove</div>
        </div>

        <div>
          <label style="color: #9ca3af; font-size: 0.9rem;">Non-Recurring Expenses ($)</label>
          <input type="number" id="nonRecurringExp" placeholder="e.g., 200000" style="width: 100%; margin-top: 4px;" value="0">
          <div style="font-size: 0.8rem; color: #6b7280; margin-top: 2px;">One-time expenses to add back</div>
        </div>

        <div>
          <label style="color: #9ca3af; font-size: 0.9rem;">Personal Expenses ($)</label>
          <input type="number" id="personalExp" placeholder="e.g., 30000" style="width: 100%; margin-top: 4px;" value="0">
          <div style="font-size: 0.8rem; color: #6b7280; margin-top: 2px;">Personal items in financials</div>
        </div>

        <div>
          <label style="color: #9ca3af; font-size: 0.9rem;">Inventory Adjustment ($)</label>
          <input type="number" id="inventoryAdj" placeholder="e.g., -25000" style="width: 100%; margin-top: 4px;" value="0">
          <div style="font-size: 0.8rem; color: #6b7280; margin-top: 2px;">Obsolete/slow-moving inventory</div>
        </div>
      </div>
    </div>

    <!-- Phase 2: Risk & Qualitative Factors -->
    <div class="help-section">
      <h3>üéØ Phase 2: Risk & Qualitative Factors</h3>
      <p style="color: #9ca3af; margin-bottom: 12px;">Assess company-specific risks that affect discount rate</p>

      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
        <div>
          <label style="color: #9ca3af; font-size: 0.9rem;">Customer Concentration (%)</label>
          <input type="number" id="customerConcentration" placeholder="0-100" min="0" max="100" style="width: 100%; margin-top: 4px;" value="20">
          <div style="font-size: 0.8rem; color: #6b7280; margin-top: 2px;">% revenue from top 5 customers</div>
        </div>

        <div>
          <label style="color: #9ca3af; font-size: 0.9rem;">Competitive Moat (1-5)</label>
          <select id="competitiveMoat" style="width: 100%; margin-top: 4px; padding: 14px 16px; border-radius: 12px; border: 2px solid #23304a; background: #101526; color: white;">
            <option value="1">1 - No moat (commodity)</option>
            <option value="2">2 - Weak moat</option>
            <option value="3" selected>3 - Moderate moat</option>
            <option value="4">4 - Strong moat</option>
            <option value="5">5 - Very strong moat</option>
          </select>
        </div>

        <div>
          <label style="color: #9ca3af; font-size: 0.9rem;">Management Quality (1-5)</label>
          <select id="managementQuality" style="width: 100%; margin-top: 4px; padding: 14px 16px; border-radius: 12px; border: 2px solid #23304a; background: #101526; color: white;">
            <option value="1">1 - Poor track record</option>
            <option value="2">2 - Below average</option>
            <option value="3" selected>3 - Average</option>
            <option value="4">4 - Above average</option>
            <option value="5">5 - Exceptional</option>
          </select>
        </div>

        <div>
          <label style="color: #9ca3af; font-size: 0.9rem;">Technology/Disruption Risk (1-5)</label>
          <select id="techRisk" style="width: 100%; margin-top: 4px; padding: 14px 16px; border-radius: 12px; border: 2px solid #23304a; background: #101526; color: white;">
            <option value="1">1 - Very low risk</option>
            <option value="2">2 - Low risk</option>
            <option value="3" selected>3 - Moderate risk</option>
            <option value="4">4 - High risk</option>
            <option value="5">5 - Very high risk</option>
          </select>
        </div>

        <div>
          <label style="color: #9ca3af; font-size: 0.9rem;">Regulatory Risk (1-5)</label>
          <select id="regulatoryRisk" style="width: 100%; margin-top: 4px; padding: 14px 16px; border-radius: 12px; border: 2px solid #23304a; background: #101526; color: white;">
            <option value="1">1 - Very low risk</option>
            <option value="2">2 - Low risk</option>
            <option value="3" selected>3 - Moderate risk</option>
            <option value="4">4 - High risk</option>
            <option value="5">5 - Very high risk</option>
          </select>
        </div>

        <div>
          <label style="color: #9ca3af; font-size: 0.9rem;">ESG Risk Score (1-5)</label>
          <select id="esgRisk" style="width: 100%; margin-top: 4px; padding: 14px 16px; border-radius: 12px; border: 2px solid #23304a; background: #101526; color: white;">
            <option value="1">1 - Excellent ESG</option>
            <option value="2">2 - Good ESG</option>
            <option value="3" selected>3 - Average ESG</option>
            <option value="4">4 - Poor ESG</option>
            <option value="5">5 - Very poor ESG</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Phase 3: Comparable Companies -->
    <div class="help-section">
      <h3>üè¢ Phase 3: Comparable Companies</h3>
      <p style="color: #9ca3af; margin-bottom: 12px;">Enter ticker symbols of comparable companies (comma-separated)</p>

      <div>
        <label style="color: #9ca3af; font-size: 0.9rem;">Peer Company Tickers</label>
        <input type="text" id="peerTickers" placeholder="e.g., MSFT, GOOGL, META (leave empty for auto-selection)" style="width: 100%; margin-top: 4px;" value="">
        <div style="font-size: 0.8rem; color: #6b7280; margin-top: 2px;">Leave empty to use industry averages</div>
      </div>
    </div>

    <!-- Phase 4: Working Capital -->
    <div class="help-section" style="border-bottom: none;">
      <h3>üí∞ Phase 4: Working Capital Assumptions</h3>
      <p style="color: #9ca3af; margin-bottom: 12px;">Customize working capital forecasting parameters</p>

      <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px;">
        <div>
          <label style="color: #9ca3af; font-size: 0.9rem;">Days Sales Outstanding (DSO)</label>
          <input type="number" id="dso" placeholder="30-90 days" min="0" max="365" style="width: 100%; margin-top: 4px;" value="45">
        </div>

        <div>
          <label style="color: #9ca3af; font-size: 0.9rem;">Days Inventory Outstanding (DIO)</label>
          <input type="number" id="dio" placeholder="30-120 days" min="0" max="365" style="width: 100%; margin-top: 4px;" value="60">
        </div>

        <div>
          <label style="color: #9ca3af; font-size: 0.9rem;">Days Payables Outstanding (DPO)</label>
          <input type="number" id="dpo" placeholder="30-90 days" min="0" max="365" style="width: 100%; margin-top: 4px;" value="45">
        </div>
      </div>

      <div style="margin-top: 12px; padding: 10px; background: rgba(76, 201, 240, 0.1); border-left: 4px solid #4cc9f0; border-radius: 8px;">
        <div style="font-size: 0.85rem; color: #4cc9f0;">
          <strong>Cash Conversion Cycle:</strong> <span id="cccPreview">60 days</span>
        </div>
      </div>
    </div>

    <div style="display: flex; gap: 12px; margin-top: 20px;">
      <button onclick="runFullValuationWithSettings()" style="flex: 1;">
        üöÄ Run Advanced Analysis
      </button>
      <button onclick="closeAdvancedSettings()" style="flex: 1; background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);">
        Cancel
      </button>
    </div>
  </div>
</div>

<script>
// ============================================================================
// PROFESSIONAL VALUATION ENGINE
// Full Implementation of "◊î◊û◊ì◊®◊ô◊ö ◊ú◊î◊¢◊®◊õ◊™ ◊©◊ï◊ï◊ô ◊ó◊ë◊®◊ï◊™"
// ============================================================================

const FINNHUB_KEY = "d3gh5ppr01qqbh56f7t0d3gh5ppr01qqbh56f7tg";
const CORS_PROXY = "https://api.allorigins.win/raw?url=";

// Current scenario (base, bull, bear)
let currentScenario = 'base';
let cachedValuation = null;

// Advanced settings object
let advancedSettings = {
  // Phase 1: Normalization
  ownerSalaryAdj: 0,
  rentAdj: 0,
  nonRecurringRev: 0,
  nonRecurringExp: 0,
  personalExp: 0,
  inventoryAdj: 0,

  // Phase 2: Risk factors
  customerConcentration: 20,
  competitiveMoat: 3,
  managementQuality: 3,
  techRisk: 3,
  regulatoryRisk: 3,
  esgRisk: 3,

  // Phase 3: Comparables
  peerTickers: '',

  // Phase 4: Working capital
  dso: 45,
  dio: 60,
  dpo: 45
};

// ============================================================================
// CACHING SYSTEM (5-minute cache)
// ============================================================================

const cache = new Map();
const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes in milliseconds

function getCacheKey(symbol) {
  return `valuation_${symbol.toUpperCase()}`;
}

function getCachedData(symbol) {
  const key = getCacheKey(symbol);
  const cached = cache.get(key);

  if (cached && (Date.now() - cached.timestamp) < CACHE_DURATION) {
    console.log(`Using cached data for ${symbol} (${Math.round((Date.now() - cached.timestamp) / 1000)}s old)`);
    return cached.data;
  }

  // Clean expired cache
  if (cached) {
    cache.delete(key);
  }

  return null;
}

function setCachedData(symbol, data) {
  const key = getCacheKey(symbol);
  cache.set(key, {
    data,
    timestamp: Date.now()
  });
  console.log(`Cached data for ${symbol}`);
}

function clearCache() {
  cache.clear();
  console.log('Cache cleared');
}

// ============================================================================
// STEP 1: DATA GATHERING
// ============================================================================

async function fetchWithRetry(url, maxRetries = 3) {
  for (let i = 0; i < maxRetries; i++) {
    try {
      console.log(`Fetching: ${url.substring(0, 100)}...`);
      const res = await fetch(url, {
        cache: "no-store",
        mode: 'cors'
      });
      console.log(`Response status: ${res.status}`);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      console.log('Data received:', Object.keys(data).length > 0 ? 'OK' : 'Empty');
      return data;
    } catch (err) {
      console.error(`Fetch attempt ${i + 1} failed:`, err.message);
      if (i === maxRetries - 1) throw err;
      await new Promise(r => setTimeout(r, 1000 * (i + 1)));
    }
  }
}

async function gatherCompanyData(symbol) {
  updateStatus("Step 1/10: Gathering real-time data...", 10);

  try {
    console.log(`Starting data gathering for ${symbol}`);

    // Fetch profile data
    const profileUrl = `https://finnhub.io/api/v1/stock/profile2?symbol=${symbol}&token=${FINNHUB_KEY}`;
    const profile = await fetchWithRetry(profileUrl);

    if (!profile || Object.keys(profile).length === 0) {
      throw new Error(`Invalid symbol: ${symbol}. No profile data found.`);
    }

    await new Promise(r => setTimeout(r, 300)); // Rate limit delay

    // Fetch quote data
    const quoteUrl = `https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${FINNHUB_KEY}`;
    const quote = await fetchWithRetry(quoteUrl);

    if (!quote || !quote.c) {
      throw new Error(`Unable to fetch current price for ${symbol}`);
    }

    await new Promise(r => setTimeout(r, 300));

    // Fetch financial metrics
    const metricsUrl = `https://finnhub.io/api/v1/stock/metric?symbol=${symbol}&metric=all&token=${FINNHUB_KEY}`;
    let metrics = {};
    try {
      const metricsData = await fetchWithRetry(metricsUrl);
      metrics = metricsData.metric || {};
    } catch (err) {
      console.warn('Metrics fetch failed, using defaults:', err.message);
    }

    await new Promise(r => setTimeout(r, 300));

    // Fetch basic financials (better coverage) - these may fail on free tier
    let incomeStatement = [];
    let balanceSheet = [];
    let cashFlow = [];

    try {
      const basicFinUrl = `https://finnhub.io/api/v1/stock/financials?symbol=${symbol}&statement=ic&freq=annual&token=${FINNHUB_KEY}`;
      const incData = await fetchWithRetry(basicFinUrl);
      incomeStatement = incData.financials || [];
      await new Promise(r => setTimeout(r, 300));
    } catch (err) {
      console.warn('Income statement fetch failed:', err.message);
    }

    try {
      const balanceUrl = `https://finnhub.io/api/v1/stock/financials?symbol=${symbol}&statement=bs&freq=annual&token=${FINNHUB_KEY}`;
      const balData = await fetchWithRetry(balanceUrl);
      balanceSheet = balData.financials || [];
      await new Promise(r => setTimeout(r, 300));
    } catch (err) {
      console.warn('Balance sheet fetch failed:', err.message);
    }

    try {
      const cashFlowUrl = `https://finnhub.io/api/v1/stock/financials?symbol=${symbol}&statement=cf&freq=annual&token=${FINNHUB_KEY}`;
      const cfData = await fetchWithRetry(cashFlowUrl);
      cashFlow = cfData.financials || [];
    } catch (err) {
      console.warn('Cash flow fetch failed:', err.message);
    }

    console.log('Data gathering complete:', {
      profile: !!profile,
      quote: !!quote,
      metricsCount: Object.keys(metrics).length,
      incomeStatements: incomeStatement.length,
      balanceSheets: balanceSheet.length,
      cashFlows: cashFlow.length
    });

    return {
      profile,
      quote,
      metrics,
      incomeStatement,
      balanceSheet,
      cashFlow,
      symbol
    };
  } catch (err) {
    console.error("Data gathering failed:", err);
    throw new Error(`Failed to fetch data for ${symbol}: ${err.message}`);
  }
}

// ============================================================================
// STEP 2: NORMALIZATION & CLEANUP
// ============================================================================

function normalizeFinancials(rawData) {
  updateStatus("Step 2/10: Normalizing and cleaning data (with adjustments)...", 20);

  const { profile, quote, metrics, incomeStatement, balanceSheet, cashFlow } = rawData;

  console.log('Applying normalization adjustments:', advancedSettings);

  // Extract key metrics with fallbacks
  // NOTE: Finnhub returns marketCap and shares in MILLIONS
  const price = quote.c || 0;
  const marketCapMillions = profile.marketCapitalization || 0;
  const sharesMillions = profile.shareOutstanding || 0;

  // Convert to actual values (multiply by 1 million)
  const marketCap = marketCapMillions * 1000000;
  const sharesOutstanding = sharesMillions * 1000000;

  // Validate: market cap should equal price * shares (roughly)
  const impliedMarketCap = price * sharesOutstanding;
  const marketCapDiff = Math.abs(marketCap - impliedMarketCap) / marketCap;

  console.log('Market Cap Validation:', {
    fromAPI: marketCap,
    calculated: impliedMarketCap,
    difference: (marketCapDiff * 100).toFixed(2) + '%',
    price,
    shares: sharesOutstanding
  });

  // Use calculated market cap if API value seems wrong (>10% difference)
  const finalMarketCap = marketCapDiff > 0.1 ? impliedMarketCap : marketCap;

  // Parse financial statements (get most recent year)
  const getMetric = (arr, field) => {
    if (!arr || arr.length === 0) return null;
    const latest = arr[0];
    return latest[field] || null;
  };

  // Income statement data (RAW)
  let revenue = getMetric(incomeStatement, 'revenue') || metrics.revenueTTM || finalMarketCap * 0.25;
  let netIncome = getMetric(incomeStatement, 'netIncome') || metrics.netIncomeTTM || revenue * 0.15;
  let operatingIncome = getMetric(incomeStatement, 'operatingIncome') || revenue * 0.20;
  let ebitda = metrics.ebitdaTTM || operatingIncome * 1.15 || revenue * 0.25;

  // ========== PHASE 1: NORMALIZATION ADJUSTMENTS ==========
  // Track total adjustments for reporting
  const normalizationAdjustments = {
    revenueAdjustments: 0,
    expenseAdjustments: 0,
    netIncomeImpact: 0
  };

  // 1. Remove non-recurring revenue
  if (advancedSettings.nonRecurringRev > 0) {
    revenue -= advancedSettings.nonRecurringRev;
    normalizationAdjustments.revenueAdjustments -= advancedSettings.nonRecurringRev;
    console.log(`Removed non-recurring revenue: $${advancedSettings.nonRecurringRev.toLocaleString()}`);
  }

  // 2. Add back non-recurring expenses (increases income)
  if (advancedSettings.nonRecurringExp > 0) {
    netIncome += advancedSettings.nonRecurringExp;
    normalizationAdjustments.expenseAdjustments += advancedSettings.nonRecurringExp;
    normalizationAdjustments.netIncomeImpact += advancedSettings.nonRecurringExp;
    console.log(`Added back non-recurring expenses: $${advancedSettings.nonRecurringExp.toLocaleString()}`);
  }

  // 3. Add back personal expenses (increases income)
  if (advancedSettings.personalExp > 0) {
    netIncome += advancedSettings.personalExp;
    normalizationAdjustments.expenseAdjustments += advancedSettings.personalExp;
    normalizationAdjustments.netIncomeImpact += advancedSettings.personalExp;
    console.log(`Added back personal expenses: $${advancedSettings.personalExp.toLocaleString()}`);
  }

  // 4. Owner salary adjustment (if paying above market, add back excess; if below, reduce income)
  if (advancedSettings.ownerSalaryAdj !== 0) {
    netIncome += advancedSettings.ownerSalaryAdj; // Positive = paying too much, add back
    normalizationAdjustments.expenseAdjustments += advancedSettings.ownerSalaryAdj;
    normalizationAdjustments.netIncomeImpact += advancedSettings.ownerSalaryAdj;
    console.log(`Owner salary adjustment: $${advancedSettings.ownerSalaryAdj.toLocaleString()}`);
  }

  // 5. Rent adjustment (related-party transactions)
  if (advancedSettings.rentAdj !== 0) {
    netIncome += advancedSettings.rentAdj; // Positive = paying above market, add back
    normalizationAdjustments.expenseAdjustments += advancedSettings.rentAdj;
    normalizationAdjustments.netIncomeImpact += advancedSettings.rentAdj;
    console.log(`Rent adjustment: $${advancedSettings.rentAdj.toLocaleString()}`);
  }

  // Recalculate operating income and EBITDA based on adjusted net income
  operatingIncome = netIncome / 0.75; // Assume net is ~75% of operating after tax
  ebitda = operatingIncome * 1.15; // Add back D&A

  console.log('Normalization summary:', {
    originalRevenue: revenue + normalizationAdjustments.revenueAdjustments,
    adjustedRevenue: revenue,
    revenueChange: normalizationAdjustments.revenueAdjustments,
    netIncomeImpact: normalizationAdjustments.netIncomeImpact,
    adjustedNetIncome: netIncome
  });

  // Balance sheet data
  let totalAssets = getMetric(balanceSheet, 'totalAssets') || metrics.totalAssets || finalMarketCap * 1.5;
  const totalEquity = getMetric(balanceSheet, 'totalStockholderEquity') || metrics.totalEquity || finalMarketCap * 0.5;
  const totalDebt = getMetric(balanceSheet, 'longTermDebt') || metrics.totalDebt || totalEquity * 0.3;
  const cashAndEquiv = getMetric(balanceSheet, 'cashAndCashEquivalents') || metrics.currentAssets * 0.3 || totalAssets * 0.1;

  // 6. Inventory adjustment (obsolete/slow-moving inventory reduction)
  if (advancedSettings.inventoryAdj !== 0) {
    totalAssets += advancedSettings.inventoryAdj; // Negative value reduces assets
    console.log(`Inventory adjustment: $${advancedSettings.inventoryAdj.toLocaleString()}`);
  }

  // Cash flow data
  const freeCashFlow = getMetric(cashFlow, 'freeCashFlow') || metrics.freeCashFlowTTM || netIncome * 0.8;
  const operatingCashFlow = getMetric(cashFlow, 'operatingCashFlow') || freeCashFlow * 1.2;
  const capex = operatingCashFlow - freeCashFlow;

  // Calculate EPS
  const eps = sharesOutstanding > 0 ? netIncome / sharesOutstanding : metrics.epsTTM || 0;

  // Get beta (unlevered and relevered)
  const betaLevered = metrics.beta || 1.2;
  const debtToEquity = totalDebt / totalEquity || 0.3;
  const taxRate = 0.21;
  const betaUnlevered = betaLevered / (1 + (1 - taxRate) * debtToEquity);

  // Calculate margins
  const netMargin = revenue > 0 ? netIncome / revenue : 0.15;
  const operatingMargin = revenue > 0 ? operatingIncome / revenue : 0.20;
  const ebitdaMargin = revenue > 0 ? ebitda / revenue : 0.25;

  // Calculate growth rates
  const revenueGrowth = metrics.revenueGrowthTTMYoy || metrics.revenueGrowth3Y || 0.10;
  const epsGrowth = metrics.epsGrowthTTMYoy || 0.10;

  // Calculate profitability metrics
  const roe = totalEquity > 0 ? netIncome / totalEquity : 0.15;
  const roa = totalAssets > 0 ? netIncome / totalAssets : 0.08;
  const roic = (totalEquity + totalDebt) > 0 ? netIncome / (totalEquity + totalDebt) : 0.12;

  return {
    price,
    marketCap: finalMarketCap,
    sharesOutstanding,
    beta: { levered: betaLevered, unlevered: betaUnlevered },
    debtToEquity,
    taxRate,

    // Normalized margins
    margins: {
      net: Math.min(Math.max(netMargin, 0.01), 0.5), // Cap between 1-50%
      operating: Math.min(Math.max(operatingMargin, 0.05), 0.6),
      ebitda: Math.min(Math.max(ebitdaMargin, 0.10), 0.7)
    },

    // Growth rates (normalized)
    growth: {
      revenue: Math.min(Math.max(revenueGrowth, -0.3), 0.5), // Cap between -30% and 50%
      earnings: Math.min(Math.max(epsGrowth, -0.5), 1.0),
      historical3Y: metrics.revenueGrowth3Y || revenueGrowth,
      historical5Y: metrics.revenueGrowth5Y || revenueGrowth
    },

    // Profitability
    profitability: {
      roe: Math.min(Math.max(roe, 0.01), 2.0), // Cap between 1% and 200%
      roa: Math.min(Math.max(roa, 0.01), 1.0),
      roic: Math.min(Math.max(roic, 0.01), 1.5)
    },

    // Financial metrics from statements
    revenue,
    ebitda,
    netIncome,
    eps,
    fcf: freeCashFlow,
    operatingCashFlow,
    capex,

    // Balance sheet
    cash: cashAndEquiv,
    debt: totalDebt,
    equity: totalEquity,
    totalAssets,

    // Ratios
    ratios: {
      pe: price > 0 && eps > 0 ? price / eps : 20,
      pb: price > 0 && totalEquity > 0 ? (price * sharesOutstanding) / totalEquity : 3,
      ps: price > 0 && revenue > 0 ? (price * sharesOutstanding) / revenue : 2,
      evToEbitda: ebitda > 0 ? (marketCap + totalDebt - cashAndEquiv) / ebitda : 15,
      evToSales: revenue > 0 ? (marketCap + totalDebt - cashAndEquiv) / revenue : 3,
      priceToFcf: price > 0 && freeCashFlow > 0 ? (price * sharesOutstanding) / freeCashFlow : 25
    },

    // Company info
    sector: profile.finnhubIndustry || "Technology",
    country: profile.country || "US",
    currency: profile.currency || "USD",
    name: profile.name || rawData.symbol,

    // Normalization tracking
    normalizationAdjustments
  };
}

// ============================================================================
// STEP 3: FORECASTING (Heart of DCF)
// ============================================================================

function forecastFinancials(normalized, scenario = 'base') {
  updateStatus("Step 3/10: Building financial forecasts (3 scenarios)...", 30);

  const years = 5;
  const projections = [];

  // Scenario-based growth assumptions
  const growthAssumptions = {
    base: {
      year1: Math.min(normalized.growth.revenue, 0.25),
      year5: 0.03, // Terminal growth
      marginExpansion: 0.01 // 1% per year
    },
    bull: {
      year1: Math.min(normalized.growth.revenue * 1.3, 0.40),
      year5: 0.04,
      marginExpansion: 0.02
    },
    bear: {
      year1: Math.max(normalized.growth.revenue * 0.6, 0.01),
      year5: 0.02,
      marginExpansion: -0.005 // Margin compression
    }
  };

  const params = growthAssumptions[scenario];

  // Starting values
  let revenue = normalized.revenue;
  let ebitdaMargin = normalized.margins.ebitda;
  let operatingMargin = normalized.margins.operating;

  for (let year = 1; year <= years; year++) {
    // Declining growth rate (linear interpolation)
    const growthRate = params.year1 + (params.year5 - params.year1) * ((year - 1) / (years - 1));
    revenue = revenue * (1 + growthRate);

    // Margin expansion/compression
    ebitdaMargin = Math.min(Math.max(ebitdaMargin + params.marginExpansion, 0.05), 0.60);
    operatingMargin = Math.min(Math.max(operatingMargin + params.marginExpansion, 0.03), 0.50);

    const ebitda = revenue * ebitdaMargin;
    const ebit = revenue * operatingMargin;
    const nopat = ebit * (1 - normalized.taxRate);

    // CapEx and Working Capital assumptions
    const depreciation = revenue * 0.03; // 3% of revenue
    const capex = revenue * 0.04; // 4% of revenue

    // ========== PHASE 4: ENHANCED WORKING CAPITAL FORECASTING ==========
    // Calculate working capital components based on DSO/DIO/DPO
    const dso = advancedSettings.dso;
    const dio = advancedSettings.dio;
    const dpo = advancedSettings.dpo;

    // Accounts receivable = Revenue * (DSO / 365)
    const accountsReceivable = revenue * (dso / 365);

    // Inventory (simplified: COGS * DIO / 365)
    const cogs = revenue * (1 - operatingMargin); // Rough COGS estimate
    const inventory = cogs * (dio / 365);

    // Accounts payable = COGS * (DPO / 365)
    const accountsPayable = cogs * (dpo / 365);

    // Working capital = AR + Inventory - AP
    const workingCapital = accountsReceivable + inventory - accountsPayable;

    // Change in WC from previous year (first year uses revenue growth as proxy)
    const changeInWC = year === 1 ?
      revenue * growthRate * 0.15 : // 15% of revenue growth
      workingCapital - (projections[year - 2].workingCapital || 0);

    // Free Cash Flow to Firm
    const fcff = nopat + depreciation - capex - changeInWC;

    projections.push({
      year,
      revenue,
      ebitda,
      ebitdaMargin,
      ebit,
      operatingMargin,
      nopat,
      depreciation,
      capex,
      changeInWC,
      fcff,
      growthRate,
      // Phase 4: Working capital details
      workingCapital,
      accountsReceivable,
      inventory,
      accountsPayable,
      dso,
      dio,
      dpo,
      ccc: dso + dio - dpo // Cash Conversion Cycle
    });
  }

  return projections;
}

// ============================================================================
// STEP 4: DISCOUNT RATE (WACC)
// ============================================================================

function calculateWACC(normalized) {
  updateStatus("Step 4/10: Computing WACC (risk-adjusted discount rate)...", 40);

  // Risk-free rate (US 10-year Treasury)
  const riskFreeRate = 0.045; // 4.5% (update periodically)

  // Equity Market Premium
  const equityMarketPremium = 0.065; // 6.5% historical US premium

  // Beta (use levered beta)
  const beta = normalized.beta.levered;

  // Size premium (market cap based)
  let sizePremium = 0;
  if (normalized.marketCap < 500000000) sizePremium = 0.04; // Small cap (<$500M)
  else if (normalized.marketCap < 5000000000) sizePremium = 0.02; // Mid cap
  else sizePremium = 0.005; // Large cap

  // Country risk premium (if not US)
  const countryRisk = normalized.country !== "US" ? 0.02 : 0;

  // ========== PHASE 2: ENHANCED RISK ASSESSMENT ==========
  // Company-specific risk premium (based on profitability + qualitative factors)
  let companyRisk = 0.01; // Base
  if (normalized.profitability.roe < 0.10) companyRisk += 0.03; // Low ROE
  if (normalized.debtToEquity > 1.5) companyRisk += 0.02; // High leverage

  // Customer concentration risk (0-3% premium)
  const customerConcentrationRisk = (advancedSettings.customerConcentration / 100) * 0.03;
  console.log(`Customer concentration risk: ${(customerConcentrationRisk * 100).toFixed(2)}% (${advancedSettings.customerConcentration}% concentration)`);

  // Competitive moat adjustment (-1% to +2%)
  // Strong moat (4-5) = reduce risk by 0.5-1%, Weak moat (1-2) = add 1-2%
  const moatAdjustment = (3 - advancedSettings.competitiveMoat) * 0.005; // Scale: -1% to +1%
  console.log(`Competitive moat adjustment: ${(moatAdjustment * 100).toFixed(2)}% (moat rating: ${advancedSettings.competitiveMoat})`);

  // Management quality adjustment (-0.75% to +0.75%)
  const managementAdjustment = (3 - advancedSettings.managementQuality) * 0.00375;
  console.log(`Management quality adjustment: ${(managementAdjustment * 100).toFixed(2)}% (rating: ${advancedSettings.managementQuality})`);

  // Technology/disruption risk (0-2% premium)
  const techRiskPremium = (advancedSettings.techRisk - 3) * 0.005; // -1% to +1%
  console.log(`Technology risk premium: ${(techRiskPremium * 100).toFixed(2)}% (rating: ${advancedSettings.techRisk})`);

  // Regulatory risk (0-2% premium)
  const regulatoryRiskPremium = (advancedSettings.regulatoryRisk - 3) * 0.005;
  console.log(`Regulatory risk premium: ${(regulatoryRiskPremium * 100).toFixed(2)}% (rating: ${advancedSettings.regulatoryRisk})`);

  // ESG risk (0-2% premium)
  const esgRiskPremium = (advancedSettings.esgRisk - 3) * 0.005;
  console.log(`ESG risk premium: ${(esgRiskPremium * 100).toFixed(2)}% (rating: ${advancedSettings.esgRisk})`);

  // Total company-specific risk
  companyRisk += customerConcentrationRisk + moatAdjustment + managementAdjustment +
                 techRiskPremium + regulatoryRiskPremium + esgRiskPremium;

  console.log(`Total company-specific risk: ${(companyRisk * 100).toFixed(2)}%`);

  // Cost of Equity (CAPM + adjustments)
  const costOfEquity = riskFreeRate +
                       (beta * equityMarketPremium) +
                       sizePremium +
                       countryRisk +
                       companyRisk;

  // Cost of Debt
  let costOfDebt = riskFreeRate + 0.02; // Base spread
  if (normalized.debtToEquity > 1) costOfDebt += 0.015; // Higher spread for leverage
  const afterTaxCostOfDebt = costOfDebt * (1 - normalized.taxRate);

  // Capital structure weights
  const totalCapital = normalized.marketCap + normalized.debt;
  const equityWeight = normalized.marketCap / totalCapital;
  const debtWeight = normalized.debt / totalCapital;

  // WACC
  const wacc = (costOfEquity * equityWeight) + (afterTaxCostOfDebt * debtWeight);

  return {
    wacc: Math.min(Math.max(wacc, 0.06), 0.20), // Cap between 6-20%
    components: {
      costOfEquity,
      costOfDebt,
      afterTaxCostOfDebt,
      equityWeight,
      debtWeight,
      riskFreeRate,
      beta,
      equityMarketPremium,
      sizePremium,
      countryRisk,
      companyRisk
    },
    // Phase 2: Detailed risk breakdown
    riskBreakdown: {
      customerConcentrationRisk,
      moatAdjustment,
      managementAdjustment,
      techRiskPremium,
      regulatoryRiskPremium,
      esgRiskPremium,
      totalQualitativeRisk: customerConcentrationRisk + moatAdjustment + managementAdjustment +
                            techRiskPremium + regulatoryRiskPremium + esgRiskPremium
    }
  };
}

// ============================================================================
// STEP 5: DCF VALUATION
// ============================================================================

function computeDCF(projections, normalized, waccData, scenario) {
  updateStatus("Step 5/10: Computing DCF valuation...", 50);

  const wacc = waccData.wacc;
  let pvFCFF = 0;

  // Discount each year's FCFF
  const discountedFlows = projections.map(p => {
    const pv = p.fcff / Math.pow(1 + wacc, p.year);
    pvFCFF += pv;
    return { ...p, discountedFCFF: pv };
  });

  // Terminal Value (Perpetuity Growth Method)
  const lastYear = projections[projections.length - 1];
  const terminalGrowth = scenario === 'bull' ? 0.03 : scenario === 'bear' ? 0.02 : 0.025;
  const terminalFCFF = lastYear.fcff * (1 + terminalGrowth);
  const terminalValue = terminalFCFF / (wacc - terminalGrowth);
  const pvTerminal = terminalValue / Math.pow(1 + wacc, projections.length);

  // Enterprise Value
  const enterpriseValue = pvFCFF + pvTerminal;

  // Equity Value = EV + Cash - Debt
  const equityValue = enterpriseValue + normalized.cash - normalized.debt;

  // Per Share Value
  const valuePerShare = equityValue / normalized.sharesOutstanding;

  return {
    pvFCFF,
    terminalValue,
    pvTerminal,
    enterpriseValue,
    equityValue,
    valuePerShare,
    discountedFlows,
    terminalGrowth
  };
}

// ============================================================================
// STEP 6: MARKET APPROACH
// ============================================================================

async function fetchPeerData(symbol) {
  console.log(`Fetching peer data for ${symbol}...`);

  try {
    await new Promise(r => setTimeout(r, 300)); // Rate limit delay

    // Fetch quote
    const quoteUrl = `https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${FINNHUB_KEY}`;
    const quote = await fetchWithRetry(quoteUrl);

    await new Promise(r => setTimeout(r, 300));

    // Fetch metrics
    const metricsUrl = `https://finnhub.io/api/v1/stock/metric?symbol=${symbol}&metric=all&token=${FINNHUB_KEY}`;
    const metricsData = await fetchWithRetry(metricsUrl);
    const metrics = metricsData.metric || {};

    await new Promise(r => setTimeout(r, 300));

    // Fetch profile
    const profileUrl = `https://finnhub.io/api/v1/stock/profile2?symbol=${symbol}&token=${FINNHUB_KEY}`;
    const profile = await fetchWithRetry(profileUrl);

    const price = quote.c || 0;
    const marketCapMillions = profile.marketCapitalization || 0;
    const sharesMillions = profile.shareOutstanding || 0;
    const marketCap = marketCapMillions * 1000000;
    const sharesOutstanding = sharesMillions * 1000000;

    const revenue = metrics.revenueTTM || 0;
    const ebitda = metrics.ebitdaTTM || 0;
    const netIncome = metrics.netIncomeTTM || 0;
    const bookValue = metrics.totalEquity || 0;
    const debt = metrics.totalDebt || 0;
    const cash = metrics.currentAssets * 0.3 || 0;

    const ev = marketCap + debt - cash;
    const eps = netIncome / sharesOutstanding;

    return {
      symbol,
      price,
      marketCap,
      revenue,
      ebitda,
      netIncome,
      bookValue,
      ev,
      eps,
      multiples: {
        evToEbitda: ebitda > 0 ? ev / ebitda : 0,
        evToSales: revenue > 0 ? ev / revenue : 0,
        pe: eps > 0 ? price / eps : 0,
        pb: bookValue > 0 ? marketCap / bookValue : 0
      }
    };
  } catch (err) {
    console.error(`Failed to fetch peer data for ${symbol}:`, err);
    return null;
  }
}

async function marketApproachValuation(normalized) {
  updateStatus("Step 6/10: Applying market multiples approach...", 60);

  // ========== PHASE 3: REAL COMPARABLE COMPANY ANALYSIS ==========
  let peerMultiples = null;
  let peerCompanies = [];

  if (advancedSettings.peerTickers && advancedSettings.peerTickers.trim() !== '') {
    const tickers = advancedSettings.peerTickers.split(',').map(t => t.trim().toUpperCase()).filter(t => t);
    console.log(`Fetching data for ${tickers.length} peer companies:`, tickers);

    updateStatus(`Step 6/10: Fetching ${tickers.length} peer companies...`, 60);

    const peerDataPromises = tickers.map(ticker => fetchPeerData(ticker));
    const peerDataResults = await Promise.all(peerDataPromises);
    peerCompanies = peerDataResults.filter(p => p !== null);

    if (peerCompanies.length > 0) {
      // Calculate median multiples from peers
      const validEVtoEBITDA = peerCompanies.map(p => p.multiples.evToEbitda).filter(m => m > 0);
      const validEVtoSales = peerCompanies.map(p => p.multiples.evToSales).filter(m => m > 0);
      const validPE = peerCompanies.map(p => p.multiples.pe).filter(m => m > 0 && m < 100);
      const validPB = peerCompanies.map(p => p.multiples.pb).filter(m => m > 0);

      const median = arr => {
        if (arr.length === 0) return 0;
        arr.sort((a, b) => a - b);
        const mid = Math.floor(arr.length / 2);
        return arr.length % 2 ? arr[mid] : (arr[mid - 1] + arr[mid]) / 2;
      };

      peerMultiples = {
        evToEbitda: median(validEVtoEBITDA) || 15,
        evToSales: median(validEVtoSales) || 3,
        pe: median(validPE) || 20,
        pb: median(validPB) || 3.5
      };

      console.log('Peer multiples (median):', peerMultiples);
      console.log('Peer companies used:', peerCompanies.map(p => ({
        symbol: p.symbol,
        evToEbitda: p.multiples.evToEbitda.toFixed(2),
        pe: p.multiples.pe.toFixed(2)
      })));

      updateStatus("Step 6/10: Applying peer-derived multiples...", 60);
    } else {
      console.warn('No valid peer data fetched, using industry defaults');
    }
  }

  // Industry average multiples (simplified - in real implementation, fetch comparable companies)
  const industryMultiples = {
    Technology: { evToEbitda: 18, evToSales: 4.5, pe: 28, pb: 5.5 },
    Finance: { evToEbitda: 12, evToSales: 2.5, pe: 15, pb: 1.8 },
    Healthcare: { evToEbitda: 16, evToSales: 3.5, pe: 22, pb: 4.0 },
    "Consumer Cyclical": { evToEbitda: 14, evToSales: 1.5, pe: 18, pb: 3.0 },
    Energy: { evToEbitda: 8, evToSales: 1.2, pe: 12, pb: 1.5 },
    Default: { evToEbitda: 15, evToSales: 3.0, pe: 20, pb: 3.5 }
  };

  // Use peer multiples if available, otherwise use industry defaults
  const baseMultiples = peerMultiples || (industryMultiples[normalized.sector] || industryMultiples.Default);

  console.log(`Using ${peerMultiples ? 'peer-derived' : 'industry default'} multiples:`, baseMultiples);

  // Apply adjustments for growth and profitability (less aggressive if using peer data)
  const growthAdjustment = peerMultiples ?
    1 + (normalized.growth.revenue - 0.10) * 0.5 : // 50% weight if peer data
    1 + (normalized.growth.revenue - 0.10); // Full weight for industry defaults

  const profitabilityAdjustment = peerMultiples ?
    1 + (normalized.profitability.roe - 0.15) * 0.5 :
    1 + (normalized.profitability.roe - 0.15);

  const adjustedMultiples = {
    evToEbitda: baseMultiples.evToEbitda * growthAdjustment * profitabilityAdjustment,
    evToSales: baseMultiples.evToSales * growthAdjustment,
    pe: baseMultiples.pe * growthAdjustment,
    pb: baseMultiples.pb * profitabilityAdjustment
  };

  // Calculate implied values
  const evFromEbitda = normalized.ebitda * adjustedMultiples.evToEbitda;
  const evFromSales = normalized.revenue * adjustedMultiples.evToSales;
  const equityFromPE = normalized.netIncome * adjustedMultiples.pe;
  const equityFromPB = normalized.equity * adjustedMultiples.pb;

  // Convert EV to Equity Value
  const equityFromEbitda = evFromEbitda + normalized.cash - normalized.debt;
  const equityFromSales = evFromSales + normalized.cash - normalized.debt;

  // Weighted average
  const weights = { ebitda: 0.35, sales: 0.15, pe: 0.35, pb: 0.15 };
  const totalEquityValue =
    equityFromEbitda * weights.ebitda +
    equityFromSales * weights.sales +
    equityFromPE * weights.pe +
    equityFromPB * weights.pb;

  const valuePerShare = totalEquityValue / normalized.sharesOutstanding;

  return {
    equityValue: totalEquityValue,
    valuePerShare,
    methods: {
      evToEbitda: { value: equityFromEbitda, multiple: adjustedMultiples.evToEbitda },
      evToSales: { value: equityFromSales, multiple: adjustedMultiples.evToSales },
      pe: { value: equityFromPE, multiple: adjustedMultiples.pe },
      pb: { value: equityFromPB, multiple: adjustedMultiples.pb }
    },
    weights,
    // Phase 3: Peer company data
    peerCompanies: peerCompanies.length > 0 ? peerCompanies : null,
    peerMultiples: peerMultiples,
    usingPeerData: peerMultiples !== null
  };
}

// ============================================================================
// STEP 7: ASSET-BASED VALUATION
// ============================================================================

function assetBasedValuation(normalized) {
  updateStatus("Step 7/10: Computing asset-based valuation...", 70);

  // Book value adjustments
  const bookValue = normalized.equity;

  // Fair value adjustments (simplified)
  // In real implementation: revalue real estate, intangibles, etc.
  const realEstateAdjustment = normalized.totalAssets * 0.02; // Assume 2% adjustment for real estate revaluation
  const intangibleAdjustment = normalized.marketCap * 0.05; // Brand value, goodwill (conservative 5%)
  const inventoryAdjustment = 0; // Assume inventory at fair value

  const adjustedBookValue = bookValue + realEstateAdjustment + intangibleAdjustment;

  // Liquidation value (conservative)
  const liquidationValue = normalized.totalAssets * 0.60 - normalized.debt; // 60% recovery on assets

  const valuePerShare = adjustedBookValue / normalized.sharesOutstanding;
  const liquidationPerShare = liquidationValue / normalized.sharesOutstanding;

  return {
    bookValue,
    adjustedBookValue,
    liquidationValue,
    valuePerShare,
    liquidationPerShare,
    adjustments: {
      realEstate: realEstateAdjustment,
      intangibles: intangibleAdjustment,
      inventory: inventoryAdjustment
    }
  };
}

// ============================================================================
// STEP 8: ADJUSTMENTS & PREMIUMS
// ============================================================================

function applyPremiumsAndDiscounts(baseValue, normalized) {
  updateStatus("Step 8/10: Applying control premiums and discounts...", 80);

  // Control premium (20-35% for acquiring control)
  const controlPremium = 0.25; // 25%
  const controlValue = baseValue * (1 + controlPremium);

  // Minority discount (inverse of control)
  const minorityDiscount = 0.20; // 20%
  const minorityValue = baseValue * (1 - minorityDiscount);

  // Marketability discount (for private/illiquid stocks)
  const isPubliclyTraded = normalized.marketCap > 100000000; // Assume public if >$100M
  const marketabilityDiscount = isPubliclyTraded ? 0 : 0.25; // 25% for private
  const marketableValue = baseValue * (1 - marketabilityDiscount);

  // Key person discount (if applicable)
  const keyPersonDiscount = 0.10; // Assume 10% dependence on key management

  return {
    baseValue,
    controlValue,
    minorityValue,
    marketableValue,
    discounts: {
      minority: minorityDiscount,
      marketability: marketabilityDiscount,
      keyPerson: keyPersonDiscount
    },
    premiums: {
      control: controlPremium
    }
  };
}

// ============================================================================
// STEP 9: SYNTHESIS (Weighted Valuation)
// ============================================================================

function synthesizeValuation(dcfResult, marketResult, assetResult, normalized) {
  updateStatus("Step 9/10: Synthesizing final valuation...", 90);

  // Book methodology weights: 55% DCF, 30% Market, 15% Asset
  const weights = {
    dcf: 0.55,
    market: 0.30,
    asset: 0.15
  };

  const weightedValue =
    dcfResult.valuePerShare * weights.dcf +
    marketResult.valuePerShare * weights.market +
    assetResult.valuePerShare * weights.asset;

  const weightedEquityValue = weightedValue * normalized.sharesOutstanding;

  // Sensitivity analysis (¬±10% on key assumptions)
  const sensitivityRanges = {
    low: weightedValue * 0.85,
    base: weightedValue,
    high: weightedValue * 1.15
  };

  // Upside/Downside vs current price
  const upside = ((weightedValue / normalized.price) - 1) * 100;

  return {
    fairValuePerShare: weightedValue,
    equityValue: weightedEquityValue,
    upside,
    weights,
    components: {
      dcf: dcfResult.valuePerShare,
      market: marketResult.valuePerShare,
      asset: assetResult.valuePerShare
    },
    sensitivityRanges
  };
}

// ============================================================================
// STEP 10: FINAL REPORT GENERATION
// ============================================================================

function generateValuationReport(symbol, normalized, dcfResult, marketResult, assetResult, synthesis, waccData, projections, adjustments, scenario) {
  updateStatus("Step 10/10: Generating final report...", 100);

  return {
    symbol,
    scenario,
    date: new Date().toISOString(),

    // Current market data
    currentPrice: normalized.price,
    marketCap: normalized.marketCap,

    // Valuation results
    fairValue: synthesis.fairValuePerShare,
    upside: synthesis.upside,

    // Methodology breakdown
    dcf: dcfResult,
    market: marketResult,
    asset: assetResult,
    synthesis,

    // Supporting data
    wacc: waccData,
    projections,
    normalized,
    adjustments,

    // Recommendation
    recommendation: getRecommendation(synthesis.upside),

    // Data quality
    dataQuality: assessDataQuality(normalized)
  };
}

function getRecommendation(upside) {
  if (upside > 30) return "Strong Buy";
  if (upside > 15) return "Buy";
  if (upside > -10) return "Hold";
  if (upside > -25) return "Sell";
  return "Strong Sell";
}

function assessDataQuality(normalized) {
  let score = 0;
  if (normalized.revenue > 0) score++;
  if (normalized.fcf > 0) score++;
  if (normalized.profitability.roe > 0.05) score++;
  if (normalized.marketCap > 100000000) score++;

  if (score >= 4) return "HIGH";
  if (score >= 2) return "MEDIUM";
  return "LOW";
}

// ============================================================================
// UI UPDATE FUNCTIONS
// ============================================================================

function updateStatus(message, progress) {
  document.getElementById("status").textContent = message;
  if (progress !== undefined) {
    document.getElementById("progressFill").style.width = progress + "%";
  }
}

function updateProgress(percent) {
  document.getElementById("progressFill").style.width = percent + "%";
}

// ============================================================================
// MAIN VALUATION ORCHESTRATOR
// ============================================================================

async function runFullValuation() {
  const symbolInput = document.getElementById("ticker");
  const valueBtn = document.getElementById("valueBtn");
  const symbol = symbolInput.value.trim().toUpperCase();

  if (!symbol) {
    alert("Please enter a ticker symbol");
    return;
  }

  // Check cache first
  const cached = getCachedData(symbol);
  if (cached) {
    cachedValuation = cached;
    renderValuationReport(cached.base);
    updateStatus(`‚úì Loaded from cache (${Math.round((Date.now() - cache.get(getCacheKey(symbol)).timestamp) / 1000)}s old)`, 100);
    document.getElementById("results").style.display = "block";
    showExportButtons();
    return;
  }

  valueBtn.disabled = true;
  valueBtn.textContent = "Analyzing...";
  document.getElementById("progressContainer").style.display = "block";
  document.getElementById("results").style.display = "none";
  hideExportButtons();

  try {
    // Step 1: Gather data
    const rawData = await gatherCompanyData(symbol);

    // Step 2: Normalize
    const normalized = normalizeFinancials(rawData);

    // Step 4: Calculate WACC first (needed for DCF)
    const waccData = calculateWACC(normalized);

    // Run all three scenarios
    const scenarios = {};
    for (const scenario of ['base', 'bull', 'bear']) {
      // Step 3: Forecast
      const projections = forecastFinancials(normalized, scenario);

      // Step 5: DCF
      const dcfResult = computeDCF(projections, normalized, waccData, scenario);

      // Step 6: Market approach
      const marketResult = marketApproachValuation(normalized);

      // Step 7: Asset-based
      const assetResult = assetBasedValuation(normalized);

      // Step 8: Adjustments
      const adjustments = applyPremiumsAndDiscounts(dcfResult.valuePerShare, normalized);

      // Step 9: Synthesis
      const synthesis = synthesizeValuation(dcfResult, marketResult, assetResult, normalized);

      // Step 10: Generate report
      const report = generateValuationReport(
        symbol, normalized, dcfResult, marketResult, assetResult,
        synthesis, waccData, projections, adjustments, scenario
      );

      scenarios[scenario] = report;
    }

    // Cache for scenario switching
    cachedValuation = scenarios;

    // Save to cache
    setCachedData(symbol, scenarios);

    // Render base case by default
    renderValuationReport(scenarios.base);

    updateStatus("‚úì Valuation complete!", 100);
    document.getElementById("results").style.display = "block";
    showExportButtons();

  } catch (err) {
    updateStatus(`Error: ${err.message}`, 0);
    console.error("Valuation error:", err);
  } finally {
    valueBtn.disabled = false;
    valueBtn.textContent = "Full DCF Analysis";
    setTimeout(() => {
      document.getElementById("progressContainer").style.display = "none";
    }, 2000);
  }
}

function switchScenario(scenario) {
  if (!cachedValuation || !cachedValuation[scenario]) return;

  currentScenario = scenario;

  // Update tab UI
  document.querySelectorAll('.scenario-tab').forEach(tab => {
    tab.classList.remove('active');
  });
  event.target.classList.add('active');

  // Render the selected scenario
  renderValuationReport(cachedValuation[scenario]);
}

// ============================================================================
// RENDERING FUNCTIONS
// ============================================================================

function renderValuationReport(report) {
  // Main cards
  document.getElementById("currentPrice").textContent = `$${report.currentPrice.toFixed(2)}`;
  document.getElementById("marketCap").textContent = `Market Cap: ${formatCurrency(report.marketCap)}`;

  document.getElementById("fairValue").textContent = `$${report.fairValue.toFixed(2)}`;
  document.getElementById("fairValueRange").textContent =
    `Range: $${report.synthesis.sensitivityRanges.low.toFixed(2)} - $${report.synthesis.sensitivityRanges.high.toFixed(2)}`;

  const upsideEl = document.getElementById("upside");
  const upsideText = report.upside > 0 ? `+${report.upside.toFixed(1)}%` : `${report.upside.toFixed(1)}%`;
  upsideEl.textContent = upsideText;
  upsideEl.className = `value ${report.upside > 15 ? 'positive' : report.upside < -15 ? 'negative' : 'neutral'}`;

  document.getElementById("recommendation").textContent = report.recommendation;

  // WACC
  document.getElementById("waccValue").textContent = `${(report.wacc.wacc * 100).toFixed(2)}%`;
  document.getElementById("waccBreakdown").textContent =
    `Ke: ${(report.wacc.components.costOfEquity * 100).toFixed(1)}% | Kd: ${(report.wacc.components.afterTaxCostOfDebt * 100).toFixed(1)}%`;

  // Data quality
  const qualityEl = document.getElementById("dataQuality");
  qualityEl.textContent = report.dataQuality;
  qualityEl.className = `data-quality quality-${report.dataQuality.toLowerCase()}`;

  // Valuation methods
  const methods = [
    { name: "DCF Model", value: report.synthesis.components.dcf, weight: report.synthesis.weights.dcf },
    { name: "Market Multiples", value: report.synthesis.components.market, weight: report.synthesis.weights.market },
    { name: "Asset-Based", value: report.synthesis.components.asset, weight: report.synthesis.weights.asset }
  ];

  document.getElementById("valuationMethods").innerHTML = methods.map(m => `
    <div class="method-card">
      <div class="method-name">${m.name} (${(m.weight * 100).toFixed(0)}%)</div>
      <div class="method-value">$${m.value.toFixed(2)}</div>
    </div>
  `).join('');

  // DCF Projection table
  let dcfHTML = '<table style="width:100%; border-collapse: collapse;"><thead><tr style="border-bottom: 2px solid #23304a;">';
  dcfHTML += '<th style="text-align:left; padding:8px;">Year</th><th style="text-align:right; padding:8px;">Revenue</th><th style="text-align:right; padding:8px;">EBITDA</th><th style="text-align:right; padding:8px;">FCFF</th><th style="text-align:right; padding:8px;">PV</th></tr></thead><tbody>';

  report.projections.forEach(p => {
    const dcData = report.dcf.discountedFlows.find(d => d.year === p.year);
    dcfHTML += `<tr style="border-bottom: 1px solid #1f2940;">
      <td style="padding:8px;">Year ${p.year}</td>
      <td style="text-align:right; padding:8px;">${formatCurrency(p.revenue)}</td>
      <td style="text-align:right; padding:8px;">${formatCurrency(p.ebitda)}</td>
      <td style="text-align:right; padding:8px;">${formatCurrency(p.fcff)}</td>
      <td style="text-align:right; padding:8px;">${formatCurrency(dcData.discountedFCFF)}</td>
    </tr>`;
  });

  dcfHTML += `<tr style="font-weight:700; background:#0b0f19;">
    <td style="padding:8px;" colspan="3">Terminal Value (Growth: ${(report.dcf.terminalGrowth * 100).toFixed(2)}%)</td>
    <td style="text-align:right; padding:8px;" colspan="2">${formatCurrency(report.dcf.pvTerminal)}</td>
  </tr>`;
  dcfHTML += `<tr style="font-weight:700; color:#4cc9f0;">
    <td style="padding:8px;" colspan="3">Enterprise Value</td>
    <td style="text-align:right; padding:8px;" colspan="2">${formatCurrency(report.dcf.enterpriseValue)}</td>
  </tr></tbody></table>`;

  document.getElementById("dcfProjection").innerHTML = dcfHTML;

  // Market approach
  let marketHTML = '';

  // Add peer company notice if used
  if (report.market.usingPeerData && report.market.peerCompanies) {
    marketHTML += `<div style="margin-bottom: 12px; padding: 10px; background: rgba(76, 201, 240, 0.1); border-left: 4px solid #4cc9f0; border-radius: 8px;">
      <strong>‚úì Using Real Peer Data</strong> (${report.market.peerCompanies.length} companies): ${report.market.peerCompanies.map(p => p.symbol).join(', ')}
    </div>`;
  }

  marketHTML += '<div class="metric-row"><span class="metric-label"><strong>Method</strong></span><span class="metric-value"><strong>Multiple</strong></span><span class="metric-value"><strong>Value</strong></span></div>';
  Object.entries(report.market.methods).forEach(([key, data]) => {
    marketHTML += `<div class="metric-row">
      <span class="metric-label">${key.toUpperCase()}</span>
      <span class="metric-value">${data.multiple.toFixed(2)}x</span>
      <span class="metric-value">${formatCurrency(data.value)}</span>
    </div>`;
  });
  marketHTML += `<div class="metric-row" style="font-weight:700; color:#4cc9f0; margin-top:12px;">
    <span class="metric-label">Weighted Average</span>
    <span class="metric-value"></span>
    <span class="metric-value">${formatCurrency(report.market.equityValue)}</span>
  </div>`;
  document.getElementById("marketApproach").innerHTML = marketHTML;

  // Asset-based
  document.getElementById("assetBased").innerHTML = `
    <div class="metric-row"><span class="metric-label">Book Value</span><span class="metric-value">${formatCurrency(report.asset.bookValue)}</span></div>
    <div class="metric-row"><span class="metric-label">Adjusted Book Value</span><span class="metric-value">${formatCurrency(report.asset.adjustedBookValue)}</span></div>
    <div class="metric-row"><span class="metric-label">Liquidation Value</span><span class="metric-value">${formatCurrency(report.asset.liquidationValue)}</span></div>
    <div class="metric-row" style="font-weight:700; color:#4cc9f0; margin-top:12px;"><span class="metric-label">Per Share</span><span class="metric-value">$${report.asset.valuePerShare.toFixed(2)}</span></div>
  `;

  // Adjustments
  document.getElementById("adjustments").innerHTML = `
    <div class="metric-row"><span class="metric-label">Base Value</span><span class="metric-value">$${report.adjustments.baseValue.toFixed(2)}</span></div>
    <div class="metric-row"><span class="metric-label">Control Premium (${(report.adjustments.premiums.control*100).toFixed(0)}%)</span><span class="metric-value">$${report.adjustments.controlValue.toFixed(2)}</span></div>
    <div class="metric-row"><span class="metric-label">Minority Discount (${(report.adjustments.discounts.minority*100).toFixed(0)}%)</span><span class="metric-value">$${report.adjustments.minorityValue.toFixed(2)}</span></div>
    <div class="metric-row"><span class="metric-label">Marketability Discount (${(report.adjustments.discounts.marketability*100).toFixed(0)}%)</span><span class="metric-value">$${report.adjustments.marketableValue.toFixed(2)}</span></div>
  `;

  // Financial metrics
  const norm = report.normalized;
  document.getElementById("financialMetrics").innerHTML = `
    <div class="metric-row"><span class="metric-label">Revenue (TTM)</span><span class="metric-value">${formatCurrency(norm.revenue)}</span></div>
    <div class="metric-row"><span class="metric-label">EBITDA (TTM)</span><span class="metric-value">${formatCurrency(norm.ebitda)}</span></div>
    <div class="metric-row"><span class="metric-label">Net Income (TTM)</span><span class="metric-value">${formatCurrency(norm.netIncome)}</span></div>
    <div class="metric-row"><span class="metric-label">Free Cash Flow</span><span class="metric-value">${formatCurrency(norm.fcf)}</span></div>
    <div class="metric-row"><span class="metric-label">EBITDA Margin</span><span class="metric-value">${(norm.margins.ebitda*100).toFixed(1)}%</span></div>
    <div class="metric-row"><span class="metric-label">Operating Margin</span><span class="metric-value">${(norm.margins.operating*100).toFixed(1)}%</span></div>
    <div class="metric-row"><span class="metric-label">Net Margin</span><span class="metric-value">${(norm.margins.net*100).toFixed(1)}%</span></div>
    <div class="metric-row"><span class="metric-label">ROE</span><span class="metric-value">${(norm.profitability.roe*100).toFixed(1)}%</span></div>
    <div class="metric-row"><span class="metric-label">ROA</span><span class="metric-value">${(norm.profitability.roa*100).toFixed(1)}%</span></div>
    <div class="metric-row"><span class="metric-label">Debt/Equity</span><span class="metric-value">${norm.debtToEquity.toFixed(2)}x</span></div>
    <div class="metric-row"><span class="metric-label">Revenue Growth (YoY)</span><span class="metric-value">${(norm.growth.revenue*100).toFixed(1)}%</span></div>
    <div class="metric-row"><span class="metric-label">EPS</span><span class="metric-value">$${norm.eps.toFixed(2)}</span></div>
  `;

  // Assumptions & Risk Breakdown
  let assumptionsHTML = '';

  // Phase 1: Normalization Adjustments (if any were applied)
  const hasNormalizationAdj = norm.normalizationAdjustments &&
    (norm.normalizationAdjustments.revenueAdjustments !== 0 ||
     norm.normalizationAdjustments.netIncomeImpact !== 0);

  if (hasNormalizationAdj) {
    assumptionsHTML += `<h4 style="color: #4cc9f0; margin-top: 0; margin-bottom: 8px;">üìä Normalization Adjustments Applied</h4>`;
    if (norm.normalizationAdjustments.revenueAdjustments !== 0) {
      assumptionsHTML += `<div class="metric-row"><span class="metric-label">Revenue Adjustments</span><span class="metric-value">${formatCurrency(norm.normalizationAdjustments.revenueAdjustments)}</span></div>`;
    }
    if (norm.normalizationAdjustments.netIncomeImpact !== 0) {
      assumptionsHTML += `<div class="metric-row"><span class="metric-label">Net Income Impact</span><span class="metric-value" style="color: ${norm.normalizationAdjustments.netIncomeImpact > 0 ? '#4ade80' : '#f87171'}">${formatCurrency(norm.normalizationAdjustments.netIncomeImpact)}</span></div>`;
    }
    assumptionsHTML += '<div style="height: 12px;"></div>';
  }

  // Phase 2: Risk Factor Breakdown
  if (report.wacc.riskBreakdown) {
    const rb = report.wacc.riskBreakdown;
    assumptionsHTML += `<h4 style="color: #4cc9f0; margin-bottom: 8px;">üéØ Qualitative Risk Assessment</h4>`;
    assumptionsHTML += `<div class="metric-row"><span class="metric-label">Customer Concentration Risk</span><span class="metric-value">${(rb.customerConcentrationRisk*100).toFixed(2)}%</span></div>`;
    assumptionsHTML += `<div class="metric-row"><span class="metric-label">Competitive Moat Adjustment</span><span class="metric-value">${(rb.moatAdjustment*100).toFixed(2)}%</span></div>`;
    assumptionsHTML += `<div class="metric-row"><span class="metric-label">Management Quality Adjustment</span><span class="metric-value">${(rb.managementAdjustment*100).toFixed(2)}%</span></div>`;
    assumptionsHTML += `<div class="metric-row"><span class="metric-label">Technology/Disruption Risk</span><span class="metric-value">${(rb.techRiskPremium*100).toFixed(2)}%</span></div>`;
    assumptionsHTML += `<div class="metric-row"><span class="metric-label">Regulatory Risk</span><span class="metric-value">${(rb.regulatoryRiskPremium*100).toFixed(2)}%</span></div>`;
    assumptionsHTML += `<div class="metric-row"><span class="metric-label">ESG Risk</span><span class="metric-value">${(rb.esgRiskPremium*100).toFixed(2)}%</span></div>`;
    assumptionsHTML += `<div class="metric-row" style="font-weight: 700; color: #4cc9f0;"><span class="metric-label">Total Qualitative Risk Premium</span><span class="metric-value">${(rb.totalQualitativeRisk*100).toFixed(2)}%</span></div>`;
    assumptionsHTML += '<div style="height: 12px;"></div>';
  }

  // Phase 4: Working Capital Metrics
  const lastProjection = report.projections[report.projections.length - 1];
  if (lastProjection.ccc !== undefined) {
    assumptionsHTML += `<h4 style="color: #4cc9f0; margin-bottom: 8px;">üí∞ Working Capital Assumptions</h4>`;
    assumptionsHTML += `<div class="metric-row"><span class="metric-label">Days Sales Outstanding (DSO)</span><span class="metric-value">${lastProjection.dso} days</span></div>`;
    assumptionsHTML += `<div class="metric-row"><span class="metric-label">Days Inventory Outstanding (DIO)</span><span class="metric-value">${lastProjection.dio} days</span></div>`;
    assumptionsHTML += `<div class="metric-row"><span class="metric-label">Days Payables Outstanding (DPO)</span><span class="metric-value">${lastProjection.dpo} days</span></div>`;
    assumptionsHTML += `<div class="metric-row" style="font-weight: 700; color: #4cc9f0;"><span class="metric-label">Cash Conversion Cycle (CCC)</span><span class="metric-value">${lastProjection.ccc} days</span></div>`;
    assumptionsHTML += '<div style="height: 12px;"></div>';
  }

  assumptionsHTML += `<h4 style="color: #4cc9f0; margin-bottom: 8px;">üìà Key Valuation Assumptions</h4>`;
  assumptionsHTML += `
    <div class="metric-row"><span class="metric-label">WACC</span><span class="metric-value">${(report.wacc.wacc*100).toFixed(2)}%</span></div>
    <div class="metric-row"><span class="metric-label">Risk-Free Rate</span><span class="metric-value">${(report.wacc.components.riskFreeRate*100).toFixed(2)}%</span></div>
    <div class="metric-row"><span class="metric-label">Beta (Levered)</span><span class="metric-value">${report.wacc.components.beta.toFixed(2)}</span></div>
    <div class="metric-row"><span class="metric-label">Equity Market Premium</span><span class="metric-value">${(report.wacc.components.equityMarketPremium*100).toFixed(2)}%</span></div>
    <div class="metric-row"><span class="metric-label">Terminal Growth Rate</span><span class="metric-value">${(report.dcf.terminalGrowth*100).toFixed(2)}%</span></div>
    <div class="metric-row"><span class="metric-label">Tax Rate</span><span class="metric-value">${(norm.taxRate*100).toFixed(1)}%</span></div>
    <div class="metric-row"><span class="metric-label">Valuation Weights</span><span class="metric-value">DCF ${(report.synthesis.weights.dcf*100).toFixed(0)}%, Market ${(report.synthesis.weights.market*100).toFixed(0)}%, Asset ${(report.synthesis.weights.asset*100).toFixed(0)}%</span></div>
  `;

  document.getElementById("assumptions").innerHTML = assumptionsHTML;

  // Book summary
  document.getElementById("bookSummary").textContent = `
◊™◊û◊¶◊ô◊™ ◊ú◊§◊ô "◊î◊û◊ì◊®◊ô◊ö ◊ú◊î◊¢◊®◊õ◊™ ◊©◊ï◊ï◊ô ◊ó◊ë◊®◊ï◊™"

1. ◊í◊ô◊©◊™ ◊î◊õ◊†◊°◊ï◊™ (DCF - ${(report.synthesis.weights.dcf*100).toFixed(0)}%):
   - WACC: ${(report.wacc.wacc*100).toFixed(2)}%
   - ◊¶◊û◊ô◊ó◊™ ◊†◊¶◊ó: ${(report.dcf.terminalGrowth*100).toFixed(2)}%
   - ◊©◊ï◊ï◊ô ◊ú◊û◊†◊ô◊î: $${report.synthesis.components.dcf.toFixed(2)}

2. ◊í◊ô◊©◊™ ◊©◊ï◊ß (${(report.synthesis.weights.market*100).toFixed(0)}%):
   - ◊û◊õ◊§◊ô◊ú◊ô◊ù ◊û◊ï◊™◊ê◊û◊ô◊ù ◊ú◊¶◊û◊ô◊ó◊î ◊ï◊®◊ï◊ï◊ó◊ô◊ï◊™
   - ◊î◊©◊ï◊ï◊ê◊î ◊ú◊ó◊ë◊®◊ï◊™ ◊ì◊ï◊û◊ï◊™ ◊ë◊û◊í◊ñ◊® ${norm.sector}
   - ◊©◊ï◊ï◊ô ◊ú◊û◊†◊ô◊î: $${report.synthesis.components.market.toFixed(2)}

3. ◊í◊ô◊©◊™ ◊†◊õ◊°◊ô◊ù (${(report.synthesis.weights.asset*100).toFixed(0)}%):
   - ◊¢◊®◊ö ◊û◊ê◊ñ◊†◊ô ◊û◊™◊ï◊ê◊ù
   - ◊î◊™◊ê◊û◊ï◊™ ◊©◊ï◊ï◊ô ◊î◊ï◊í◊ü ◊ú◊†◊õ◊°◊ô◊ù
   - ◊©◊ï◊ï◊ô ◊ú◊û◊†◊ô◊î: $${report.synthesis.components.asset.toFixed(2)}

4. ◊©◊ô◊ú◊ï◊ë ◊ï◊î◊™◊ê◊û◊ï◊™:
   - ◊§◊®◊û◊ô◊ô◊™ ◊©◊ú◊ô◊ò◊î: ${(report.adjustments.premiums.control*100).toFixed(0)}%
   - ◊î◊ô◊ï◊ï◊ü ◊û◊ô◊¢◊ï◊ò: ${(report.adjustments.discounts.minority*100).toFixed(0)}%
   - ◊î◊™◊ê◊û◊™ ◊°◊ó◊ô◊®◊ï◊™: ${(report.adjustments.discounts.marketability*100).toFixed(0)}%

5. ◊û◊°◊ß◊†◊î:
   - ◊©◊ï◊ï◊ô ◊î◊ï◊í◊ü ◊ú◊û◊†◊ô◊î: $${report.fairValue.toFixed(2)}
   - ◊ò◊ï◊ï◊ó ◊®◊í◊ô◊©◊ï◊™: $${report.synthesis.sensitivityRanges.low.toFixed(2)} - $${report.synthesis.sensitivityRanges.high.toFixed(2)}
   - ◊§◊ï◊ò◊†◊¶◊ô◊ê◊ú: ${report.upside.toFixed(1)}%
   - ◊î◊û◊ú◊¶◊î: ${report.recommendation}

◊™◊ê◊®◊ô◊ö ◊î◊¢◊®◊õ◊î: ${new Date(report.date).toLocaleDateString('he-IL')}
◊ê◊ô◊õ◊ï◊™ ◊†◊™◊ï◊†◊ô◊ù: ${report.dataQuality}
◊™◊®◊ó◊ô◊©: ${report.scenario.toUpperCase()}
`;
}

// ============================================================================
// UTILITY FUNCTIONS
// ============================================================================

function formatCurrency(num) {
  if (Math.abs(num) >= 1e12) return `$${(num/1e12).toFixed(2)}T`;
  if (Math.abs(num) >= 1e9) return `$${(num/1e9).toFixed(2)}B`;
  if (Math.abs(num) >= 1e6) return `$${(num/1e6).toFixed(2)}M`;
  if (Math.abs(num) >= 1e3) return `$${(num/1e3).toFixed(2)}K`;
  return `$${num.toFixed(2)}`;
}

function formatNumber(num) {
  if (Math.abs(num) >= 1e12) return `${(num/1e12).toFixed(2)}T`;
  if (Math.abs(num) >= 1e9) return `${(num/1e9).toFixed(2)}B`;
  if (Math.abs(num) >= 1e6) return `${(num/1e6).toFixed(2)}M`;
  if (Math.abs(num) >= 1e3) return `${(num/1e3).toFixed(2)}K`;
  return num.toLocaleString();
}

// ============================================================================
// HELP MODAL FUNCTIONS
// ============================================================================

function showHelp() {
  document.getElementById('helpModal').style.display = 'block';
}

function closeHelp() {
  document.getElementById('helpModal').style.display = 'none';
}

function tryTicker(ticker) {
  document.getElementById('ticker').value = ticker;
  closeHelp();
  showAdvancedSettings();
}

// Close modal when clicking outside
window.onclick = function(event) {
  const helpModal = document.getElementById('helpModal');
  const advModal = document.getElementById('advancedModal');

  if (event.target == helpModal) {
    closeHelp();
  }
  if (event.target == advModal) {
    closeAdvancedSettings();
  }
}

// ============================================================================
// ADVANCED SETTINGS MODAL FUNCTIONS
// ============================================================================

function showAdvancedSettings() {
  document.getElementById('advancedModal').style.display = 'block';
  updateCCCPreview();

  // Attach event listeners for real-time CCC update
  ['dso', 'dio', 'dpo'].forEach(id => {
    document.getElementById(id).addEventListener('input', updateCCCPreview);
  });
}

function closeAdvancedSettings() {
  document.getElementById('advancedModal').style.display = 'none';
}

function updateCCCPreview() {
  const dso = parseFloat(document.getElementById('dso').value) || 45;
  const dio = parseFloat(document.getElementById('dio').value) || 60;
  const dpo = parseFloat(document.getElementById('dpo').value) || 45;
  const ccc = dso + dio - dpo;

  document.getElementById('cccPreview').textContent = `${ccc} days`;
}

function collectAdvancedSettings() {
  advancedSettings = {
    // Phase 1: Normalization
    ownerSalaryAdj: parseFloat(document.getElementById('ownerSalaryAdj').value) || 0,
    rentAdj: parseFloat(document.getElementById('rentAdj').value) || 0,
    nonRecurringRev: parseFloat(document.getElementById('nonRecurringRev').value) || 0,
    nonRecurringExp: parseFloat(document.getElementById('nonRecurringExp').value) || 0,
    personalExp: parseFloat(document.getElementById('personalExp').value) || 0,
    inventoryAdj: parseFloat(document.getElementById('inventoryAdj').value) || 0,

    // Phase 2: Risk factors
    customerConcentration: parseFloat(document.getElementById('customerConcentration').value) || 20,
    competitiveMoat: parseInt(document.getElementById('competitiveMoat').value) || 3,
    managementQuality: parseInt(document.getElementById('managementQuality').value) || 3,
    techRisk: parseInt(document.getElementById('techRisk').value) || 3,
    regulatoryRisk: parseInt(document.getElementById('regulatoryRisk').value) || 3,
    esgRisk: parseInt(document.getElementById('esgRisk').value) || 3,

    // Phase 3: Comparables
    peerTickers: document.getElementById('peerTickers').value.trim(),

    // Phase 4: Working capital
    dso: parseFloat(document.getElementById('dso').value) || 45,
    dio: parseFloat(document.getElementById('dio').value) || 60,
    dpo: parseFloat(document.getElementById('dpo').value) || 45
  };

  console.log('Advanced settings collected:', advancedSettings);
  return advancedSettings;
}

function runFullValuationWithSettings() {
  collectAdvancedSettings();
  closeAdvancedSettings();
  runFullValuation();
}

// ============================================================================
// EXPORT FUNCTIONS
// ============================================================================

function showExportButtons() {
  const container = document.getElementById('exportButtons');
  container.innerHTML = `
    <button onclick="exportToPDF()" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); min-width: auto; padding: 10px 16px;">
      üìÑ Export PDF
    </button>
    <button onclick="exportToExcel()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); min-width: auto; padding: 10px 16px;">
      üìä Export Excel
    </button>
    <button onclick="exportToJSON()" style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); min-width: auto; padding: 10px 16px;">
      üíæ Export JSON
    </button>
    <button onclick="shareResults()" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); min-width: auto; padding: 10px 16px;">
      üîó Share Link
    </button>
  `;
}

function hideExportButtons() {
  document.getElementById('exportButtons').innerHTML = '';
}

function exportToPDF() {
  if (!cachedValuation) {
    alert('No valuation data available. Please run an analysis first.');
    return;
  }

  updateStatus('Generating PDF...', 50);

  const report = cachedValuation[currentScenario];
  const symbol = report.symbol;
  const date = new Date().toLocaleDateString();

  // Create PDF content
  let pdfContent = `
Professional Valuation Report
${symbol} - ${currentScenario.toUpperCase()} Case
Generated: ${date}

SUMMARY
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Current Price:     $${report.currentPrice.toFixed(2)}
Fair Value:        $${report.fairValue.toFixed(2)}
Upside/Downside:   ${report.upside.toFixed(1)}%
Recommendation:    ${report.recommendation}
Data Quality:      ${report.dataQuality}

VALUATION METHODOLOGY
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
DCF Model (55%):        $${report.synthesis.components.dcf.toFixed(2)}
Market Multiples (30%): $${report.synthesis.components.market.toFixed(2)}
Asset-Based (15%):      $${report.synthesis.components.asset.toFixed(2)}

WACC CALCULATION
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
WACC:                   ${(report.wacc.wacc * 100).toFixed(2)}%
Cost of Equity:         ${(report.wacc.components.costOfEquity * 100).toFixed(2)}%
Cost of Debt (AT):      ${(report.wacc.components.afterTaxCostOfDebt * 100).toFixed(2)}%
Beta (Levered):         ${report.wacc.components.beta.toFixed(2)}
Risk-Free Rate:         ${(report.wacc.components.riskFreeRate * 100).toFixed(2)}%

DCF PROJECTIONS
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
${report.projections.map(p => `Year ${p.year}: Revenue ${formatCurrency(p.revenue)}, FCFF ${formatCurrency(p.fcff)}`).join('\n')}
Terminal Value: ${formatCurrency(report.dcf.pvTerminal)}
Enterprise Value: ${formatCurrency(report.dcf.enterpriseValue)}

FINANCIAL METRICS
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Revenue (TTM):      ${formatCurrency(report.normalized.revenue)}
EBITDA (TTM):       ${formatCurrency(report.normalized.ebitda)}
Net Income (TTM):   ${formatCurrency(report.normalized.netIncome)}
Free Cash Flow:     ${formatCurrency(report.normalized.fcf)}
EPS:                $${report.normalized.eps.toFixed(2)}

MARGINS & PROFITABILITY
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
EBITDA Margin:      ${(report.normalized.margins.ebitda * 100).toFixed(1)}%
Operating Margin:   ${(report.normalized.margins.operating * 100).toFixed(1)}%
Net Margin:         ${(report.normalized.margins.net * 100).toFixed(1)}%
ROE:                ${(report.normalized.profitability.roe * 100).toFixed(1)}%
ROA:                ${(report.normalized.profitability.roa * 100).toFixed(1)}%

‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
‚ö†Ô∏è  DISCLAIMER: This valuation is for educational purposes only and
    does not constitute investment advice. Always consult with qualified
    professionals before making investment decisions.

Generated with Professional Valuation Engine
https://liyamflx.github.io/BOOK/
  `;

  // Download as text file (PDF generation requires library)
  const blob = new Blob([pdfContent], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `Valuation_${symbol}_${currentScenario}_${date.replace(/\//g, '-')}.txt`;
  a.click();
  URL.revokeObjectURL(url);

  updateStatus('‚úì PDF exported successfully!', 100);
  setTimeout(() => updateStatus('‚úì Valuation complete!', 100), 2000);
}

function exportToExcel() {
  if (!cachedValuation) {
    alert('No valuation data available. Please run an analysis first.');
    return;
  }

  updateStatus('Generating Excel file...', 50);

  const report = cachedValuation[currentScenario];
  const symbol = report.symbol;

  // Create CSV content
  let csv = 'Professional Valuation Report\n';
  csv += `Symbol,${symbol}\n`;
  csv += `Scenario,${currentScenario.toUpperCase()}\n`;
  csv += `Date,${new Date().toLocaleDateString()}\n\n`;

  csv += 'SUMMARY\n';
  csv += 'Metric,Value\n';
  csv += `Current Price,$${report.currentPrice.toFixed(2)}\n`;
  csv += `Fair Value,$${report.fairValue.toFixed(2)}\n`;
  csv += `Upside/Downside,${report.upside.toFixed(1)}%\n`;
  csv += `Recommendation,${report.recommendation}\n`;
  csv += `Data Quality,${report.dataQuality}\n\n`;

  csv += 'DCF PROJECTIONS\n';
  csv += 'Year,Revenue,EBITDA,FCFF,Discounted FCFF\n';
  report.projections.forEach((p, i) => {
    const dc = report.dcf.discountedFlows[i];
    csv += `${p.year},${p.revenue.toFixed(0)},${p.ebitda.toFixed(0)},${p.fcff.toFixed(0)},${dc.discountedFCFF.toFixed(0)}\n`;
  });
  csv += `Terminal Value,,,${report.dcf.terminalValue.toFixed(0)},${report.dcf.pvTerminal.toFixed(0)}\n\n`;

  csv += 'FINANCIAL METRICS\n';
  csv += 'Metric,Value\n';
  csv += `Revenue (TTM),${report.normalized.revenue.toFixed(0)}\n`;
  csv += `EBITDA (TTM),${report.normalized.ebitda.toFixed(0)}\n`;
  csv += `Net Income (TTM),${report.normalized.netIncome.toFixed(0)}\n`;
  csv += `Free Cash Flow,${report.normalized.fcf.toFixed(0)}\n`;
  csv += `EPS,$${report.normalized.eps.toFixed(2)}\n`;
  csv += `EBITDA Margin,${(report.normalized.margins.ebitda * 100).toFixed(1)}%\n`;
  csv += `Net Margin,${(report.normalized.margins.net * 100).toFixed(1)}%\n`;
  csv += `ROE,${(report.normalized.profitability.roe * 100).toFixed(1)}%\n\n`;

  csv += 'WACC COMPONENTS\n';
  csv += 'Component,Value\n';
  csv += `WACC,${(report.wacc.wacc * 100).toFixed(2)}%\n`;
  csv += `Cost of Equity,${(report.wacc.components.costOfEquity * 100).toFixed(2)}%\n`;
  csv += `Cost of Debt (AT),${(report.wacc.components.afterTaxCostOfDebt * 100).toFixed(2)}%\n`;
  csv += `Beta,${report.wacc.components.beta.toFixed(2)}\n`;
  csv += `Risk-Free Rate,${(report.wacc.components.riskFreeRate * 100).toFixed(2)}%\n`;

  // Download CSV
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `Valuation_${symbol}_${currentScenario}_${new Date().toLocaleDateString().replace(/\//g, '-')}.csv`;
  a.click();
  URL.revokeObjectURL(url);

  updateStatus('‚úì Excel file exported successfully!', 100);
  setTimeout(() => updateStatus('‚úì Valuation complete!', 100), 2000);
}

function exportToJSON() {
  if (!cachedValuation) {
    alert('No valuation data available. Please run an analysis first.');
    return;
  }

  updateStatus('Generating JSON file...', 50);

  const report = cachedValuation[currentScenario];
  const jsonData = JSON.stringify(report, null, 2);

  const blob = new Blob([jsonData], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `Valuation_${report.symbol}_${currentScenario}_${new Date().toISOString().split('T')[0]}.json`;
  a.click();
  URL.revokeObjectURL(url);

  updateStatus('‚úì JSON exported successfully!', 100);
  setTimeout(() => updateStatus('‚úì Valuation complete!', 100), 2000);
}

function shareResults() {
  if (!cachedValuation) {
    alert('No valuation data available. Please run an analysis first.');
    return;
  }

  const report = cachedValuation[currentScenario];
  const symbol = report.symbol;
  const fairValue = report.fairValue.toFixed(2);
  const upside = report.upside.toFixed(1);

  const shareText = `${symbol} Valuation Analysis (${currentScenario} case):\nFair Value: $${fairValue}\nUpside: ${upside}%\nRecommendation: ${report.recommendation}\n\nGenerated with Professional Valuation Engine\nhttps://liyamflx.github.io/BOOK/?symbol=${symbol}`;

  // Copy to clipboard
  navigator.clipboard.writeText(shareText).then(() => {
    alert('Share link copied to clipboard!\n\n' + shareText);
  }).catch(() => {
    // Fallback for older browsers
    const textarea = document.createElement('textarea');
    textarea.value = shareText;
    document.body.appendChild(textarea);
    textarea.select();
    document.execCommand('copy');
    document.body.removeChild(textarea);
    alert('Share text copied to clipboard!\n\n' + shareText);
  });
}

// ============================================================================
// API TEST FUNCTION
// ============================================================================

async function testAPI() {
  const symbol = document.getElementById("ticker").value.trim().toUpperCase() || 'AAPL';
  updateStatus(`Testing API with ${symbol}...`, 50);

  console.log('=== API TEST START ===');
  console.log('Symbol:', symbol);
  console.log('API Key:', FINNHUB_KEY ? 'Present' : 'Missing');

  try {
    // Test 1: Quote (simplest)
    const quoteUrl = `https://finnhub.io/api/v1/quote?symbol=${symbol}&token=${FINNHUB_KEY}`;
    console.log('Test 1: Fetching quote...');
    const quote = await fetch(quoteUrl);
    const quoteData = await quote.json();
    console.log('Quote data:', quoteData);

    if (quoteData.c) {
      updateStatus(`‚úì API Working! Current price: $${quoteData.c}`, 100);
      alert(`API Test Successful!\n\nSymbol: ${symbol}\nPrice: $${quoteData.c}\n\nCheck console (F12) for detailed logs.`);
    } else {
      updateStatus('‚ö† API responded but data incomplete', 50);
      alert('API responded but returned incomplete data. Check console (F12) for details.');
    }
  } catch (err) {
    console.error('API Test Failed:', err);
    updateStatus(`‚úó API Test Failed: ${err.message}`, 0);
    alert(`API Test Failed!\n\nError: ${err.message}\n\nPossible causes:\n1. CORS issue (run from a web server, not file://)\n2. Invalid API key\n3. Network connectivity\n4. Rate limit exceeded\n\nCheck browser console (F12) for details.`);
  }

  console.log('=== API TEST END ===');
}

</script>
</body>
</html>
